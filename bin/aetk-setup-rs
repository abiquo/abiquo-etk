#!/usr/bin/env ruby
require 'logger'
require 'abiquo-etk'

CONFIG_FILE='/etc/sysconfig/abiquo-rs'

Log = Logger.new "/var/log/abiquo-etk.log"
Log.level = Logger::INFO

begin
	@settings = {}
	if File.exist? CONFIG_FILE
    @settings = abiquo_rs_settings
	else
		Log.error "Config file #{CONFIG_FILE} does not exist. Exit."
		exit
	end
  repo = @settings['abiquo_nfs_repository']
  if repo =~ /localhost|127.0.0.1/
    if File.exist? '/etc/sysconfig/abiquo-server'
      Log.info "NFS Repository points to localhost, fixing..."
      s = abiquo_server_settings
      repo = s['abiquo_server_ip'] + ':/opt/vm_repository'
    end
  end
  Log.info "Setting nfs-repository to #{repo}"
  `abicli set nfs-repository #{repo}`
  Log.info "Setting cifs-repository to #{repo}"
  `abicli set cifs-repository //your-cifs-server-ip-here/opt/vm_repository`

rescue Exception => e
	Log.error "Unhandled exception: #{e.message}"
	Log.error "Unhandled exception: #{e.backtrace}"
end


